<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest2.json?v=5">

  <!-- iOS support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

  <title>Weather Nowcast</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    .frameViewport {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
      background: #000;
    }

    /* The iframe is treated like a giant image */
    #radarFrame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2000px;   /* fixed size so transforms work */
      height: 2000px;
      transform-origin: center center;
      border: 0;
    }
  </style>

    <script>
    window.onload = () => {

      // --- CONSTANTS SECTION ---
      let scale = 0.5;          // 50% zoom
      let offsetX = 0;          // pan X
      let offsetY = 0;          // pan Y
      const MIN_SCALE = 0.3;
      const MAX_SCALE = 2.0;
      // --------------------------

      const frame = document.getElementById("radarFrame");
      const viewport = document.getElementById("viewport");

      function applyTransform() {
        frame.style.transform =
          `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px)) scale(${scale})`;
      }

      // ðŸš€ CRITICAL FIX: wait for iframe to load before applying transforms
      frame.addEventListener("load", () => {
        // Give Chrome one more tick to finalize layout
        requestAnimationFrame(() => {
          applyTransform();
        });
      });

      // --- DRAG TO PAN ---
      let dragging = false;
      let lastX = 0;
      let lastY = 0;

      viewport.addEventListener("mousedown", e => {
        dragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
      });

      viewport.addEventListener("mousemove", e => {
        if (!dragging) return;
        offsetX += (e.clientX - lastX);
        offsetY += (e.clientY - lastY);
        lastX = e.clientX;
        lastY = e.clientY;
        applyTransform();
      });

      viewport.addEventListener("mouseup", () => dragging = false);
      viewport.addEventListener("mouseleave", () => dragging = false);

      // --- TOUCH DRAG ---
      viewport.addEventListener("touchstart", e => {
        if (e.touches.length === 1) {
          lastX = e.touches[0].clientX;
          lastY = e.touches[0].clientY;
        }
      });

      viewport.addEventListener("touchmove", e => {
        if (e.touches.length === 1) {
          offsetX += (e.touches[0].clientX - lastX);
          offsetY += (e.touches[0].clientY - lastY);
          lastX = e.touches[0].clientX;
          lastY = e.touches[0].clientY;
          applyTransform();
        }
      });

      // --- PINCH TO ZOOM ---
      let lastDist = 0;

      viewport.addEventListener("touchmove", e => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx*dx + dy*dy);

          if (lastDist !== 0) {
            const delta = dist - lastDist;
            scale += delta * 0.002;
            scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale));
            applyTransform();
          }
          lastDist = dist;
        }
      });

      viewport.addEventListener("touchend", () => {
        lastDist = 0;
      });

      // --- MOUSE WHEEL ZOOM ---
      viewport.addEventListener("wheel", e => {
        scale += (e.deltaY > 0 ? -0.05 : 0.05);
        scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale));
        applyTransform();
      });

      // Register service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }

    }; // END window.onload
    </script>
</head>

<body>
    <div class="frameViewport" id="viewport">
      <iframe id="radarFrame"
              src="https://otaki.synology.me/weather/nowcast/wellington/">
      </iframe>
    </div>
</body>
</html>
