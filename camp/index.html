<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loadingâ€¦</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">
<link rel="apple-touch-icon" href="apple-icon-180.png">
</head>
<body>

<script>
// ------------------------------------------------------------
// Service worker
// ------------------------------------------------------------
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}

// ------------------------------------------------------------
// PLATFORM DETECTION
// ------------------------------------------------------------
function isIOS() {
    const ua = navigator.userAgent.toLowerCase();
    return ua.includes("iphone") ||
           ua.includes("ipad")  ||
           ua.includes("ipod")  ||
           (ua.includes("like mac os x") && ua.includes("mobile"));
}

function isAndroid() {
    return navigator.userAgent.toLowerCase().includes("android");
}

function isWindows() {
    return navigator.userAgent.toLowerCase().includes("windows");
}

// ------------------------------------------------------------
// BROWSER DETECTION
// ------------------------------------------------------------
function isFirefox() {
    if (typeof InstallTrigger !== "undefined") return true;
    const ua = navigator.userAgent;
    return ua.includes("Firefox") && !ua.includes("FxiOS");
}

function isSafariIOS() {
    const ua = navigator.userAgent;
    if (!isIOS()) return false;

    const isSafariUA =
        ua.includes("Safari") &&
        !ua.includes("CriOS") &&
        !ua.includes("FxiOS") &&
        !ua.includes("EdgiOS") &&
        !ua.includes("DuckDuckGo");

    return isSafariUA;
}

// ------------------------------------------------------------
// STANDALONE DETECTION
// ------------------------------------------------------------
function isStandalone() {
    if (window.matchMedia('(display-mode: standalone)').matches) return true;
    if ('standalone' in navigator && navigator.standalone === true) return true;
    return false;
}

// ------------------------------------------------------------
// LOAD USER PREFERENCES FROM localStorage
// ------------------------------------------------------------
function loadPreferences() {
    const prefs = {};

    // useGoogleMaps: default = false (off)
    const storedMaps = localStorage.getItem("useGoogleMaps");
    prefs.useGoogleMaps = storedMaps === "true";

    // helpNudgeShown: default = false (not shown yet)
    const storedHelp = localStorage.getItem("helpNudgeShown");
    prefs.helpNudgeShown = storedHelp === "true";

    return prefs;
}

// ------------------------------------------------------------
// APPLY DEBUG OVERRIDES FROM URL
//   /camp/?usegmaps=true
// ------------------------------------------------------------
function applyDebugOverrides(prefs) {
    const url = new URL(window.location.href);

    const overrideMaps = url.searchParams.get("usegmaps");
    if (overrideMaps === "true") prefs.useGoogleMaps = true;
    if (overrideMaps === "false") prefs.useGoogleMaps = false;

    // (You could add debug for helpNudgeShown later if you want)
    return prefs;
}

// ------------------------------------------------------------
// MAIN REDIRECT
// ------------------------------------------------------------
window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams();

    // PLATFORM
    if (isIOS()) params.set("platform", "ios");
    else if (isAndroid()) params.set("platform", "android");
    else if (isWindows()) params.set("platform", "windows");
    else params.set("platform", "other");

    // BROWSER
    if (isFirefox()) params.set("browser", "firefox");
    else if (isSafariIOS()) params.set("browser", "safari");
    else params.set("browser", "other");

    // STANDALONE
    params.set("standalone", isStandalone() ? "true" : "false");

    // PREFERENCES
    let prefs = loadPreferences();
    prefs = applyDebugOverrides(prefs);

    params.set("usegmaps", prefs.useGoogleMaps ? "true" : "false");
    params.set("helpnudge", prefs.helpNudgeShown ? "true" : "false");

    // REDIRECT TO PWA
    window.location.href = "app.html?" + params.toString();
});
</script>

</body>
</html>